(function(){var b,d;b={text_loading:"Loading...",is_safari:!1,is_ie:!1,socket:null,is_modal_pop:!1,did_load_func:{},setup:function(){this.setup_nav();this.setup_link();this.setup_enter_submit();return window.onpopstate=function(a){return b.pop_state(a.state)}},pop_state:function(a){this.is_modal_pop?this.is_modal_pop=!1:a&&(a.is_pop=!0,this.ajax(a,!1))},ajax:function(a,g){var e;e=$("#js_navigation li.cs_active").index();null==a.method&&(a.method="get");"get"!==a.method&&(g=!1);$.ajax({url:a.href,
type:a.method,cache:!1,data:a.data,async:!(b.is_safari&&a.is_pop),beforeSend:function(c){var g;g="/"===a.href?0:$("#js_navigation li a[href*='"+a.href+"']").parent().index();b.nav_select(g);c.setRequestHeader("X-ajax","ajax");return b.loading_on(b.text_loading)},error:function(a){b.loading_off();b.error_message(a.status);return b.nav_select(e)},success:function(c,f,e){var d,h,l,k;if(c.__redirect)b.ajax({href:c.__redirect},!0);else if(b.loading_off(),f=e.getResponseHeader("content-type"),0<=f.indexOf("json")&&
400===c.__status)for(k=Object.keys(c),h=0,l=k.length;h<l;h++)e=k[h],d=c[e],f=$("#"+e).closest(".control-group"),f.find(".help-inline").remove(),d?(f.addClass("error"),f.find(".controls").append($("<label for='"+e+"' class='help-inline'>"+d+"</label>"))):f.removeClass("error");else{$(".modal.in").modal("hide");g?((a.href!==location.pathname||0<=location.href.indexOf("?"))&&history.pushState(a,document.title,a.href),$("html, body").animate({scrollTop:0},500,"easeOutExpo")):history.state&&history.state.is_modal&&
(b.is_modal_pop=!0,history.back());if(f=c.match(/<!ajax>/))return c=c.replace(/<!ajax>/,""),c=$("<div id='js_root'>"+c+"</div>"),document.title=c.find("title").text(),c.find(".js_ajax").each(function(){var a;a=$(this).attr("data-ajax-target");$("#"+a).html($(this).find("#"+a).html());$("#"+a).attr("class",$(this).find("#"+a).attr("class"))}),b.after_page_loaded();location.reload()}}});return!1},error_message:function(){return $.av.pop({title:"Error",message:"Loading failed, please try again later.",
template:"error"})},validation:function(a){var b;b=!0;a.find("input, textarea").each(function(){var a;if((a=$(this).attr("validation"))&&0<a.length){if($(this).val().match(a))return $(this).closest(".control-group").removeClass("error"),$(this).parent().find(".error_msg").remove();$(this).closest(".control-group").addClass("error");$(this).parent().find(".error_msg").remove();$(this).attr("msg")&&$(this).parent().append($('<label for="'+$(this).attr("id")+'" class="error_msg help-inline">'+$(this).attr("msg")+
"</label>"));return b=!1}});return b},loading_on:function(){return $("body, a, .table-pointer tbody tr").css({cursor:"wait"})},loading_off:function(){$("body").css({cursor:"default"});return $("a, .table-pointer tbody tr").css({cursor:"pointer"})},nav_select:function(a){if(0<=a&&!$($("#js_navigation li")[a]).hasClass("active"))return $("#js_navigation li").removeClass("active"),$($("#js_navigation li")[a]).addClass("active")},setup_nav:function(){var a;if(a=location.href.match(/\w(\/\w*)/))return a=
"/"===a[1]?0:$('#js_navigation li a[href*="'+a[1]+'"]').parent().index(),$("#js_navigation li").removeClass("active"),$($("#js_navigation li")[a]).addClass("active")},setup_link:function(){if(!this.is_ie)return $(document).on("click",'a:not([href*="#"])',function(a){if(!a.metaKey){if(0<$(this).closest(".active").length&&0<$(this).closest(".menu").length)return!1;if((a=$(this).attr("href"))&&!$(this).attr("target"))return b.ajax({href:a},!0),!1}}),$(document).on("submit",'form[method=get]:not([action*="#"])',
function(){var a;a=$(this).attr("action")+"?"+$(this).serialize();b.ajax({href:a},!0);return!1}),$(document).on("submit",'form[method=post]:not([action*="#"])',function(){var a;b.validation($(this))&&(a=$(this).attr("action"),b.ajax({href:a,data:$(this).serialize(),method:"post"}),$(".modal.in").modal("hide"));return!1})},setup_enter_submit:function(){return $(document).on("keypress",".enter-submit",function(a){if(13===a.keyCode&&a.ctrlKey)return $(this).closest("form").submit(),!1})},after_page_loaded:function(){b.setup_datetime();
b.setup_focus();b.setup_tooltip();return b.setup_chat()},setup_datetime:function(){return $(".datetime").each(function(){var a;try{return a=new Date($(this).attr("datetime")),$(this).html(a.toFormat($(this).attr("format")))}catch(b){}})},setup_focus:function(){return $(".focus").select()},setup_tooltip:function(){return $('[rel="tooltip"]').tooltip()},setup_chat:function(){var a;if(0<$("#chat").length)return a=window.sessionStorage.chat_token,$.ajax({type:"post",url:"/chat/setup",dataType:"json",
cache:!1,data:{chat_token:a},success:function(a){window.sessionStorage.chat_token=a.chat_token;$("#chat_name").val(a.name);a=new goog.appengine.Channel(a.channel_token);b.socket=a.open();b.socket.onmessage=b.chat_on_message;return b.socket.onerror=b.chat_on_error}});if(b.socket)return b.socket.close()},chat_on_message:function(a){a=JSON.parse(a.data);a.rename&&($("#chat_board").append(a.rename.old_name+" rename to "+a.rename.new_name+"\n"),$("#chat_name").val(a.rename.new_name));a.message&&$("#chat_board").append(a.name+
": "+a.message+"\n");return $("#chat_board").animate({scrollTop:$("#chat_board").prop("scrollHeight")},500,"easeOutExpo")},chat_on_error:function(){window.sessionStorage.removeItem("chat_token");return this.setup_chat()}};window.core=b;d=navigator.userAgent.toLowerCase();b.is_safari=-1!==d.indexOf("safari")&&-1===d.indexOf("chrome");b.is_ie=-1!==d.indexOf("msie")}).call(this);
